<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pallet Scanner Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #1e293b; margin-top: 0; }
        #reader { border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f1f5f9; }
        .btn-confirm { width: 100%; padding: 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; display: none; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì¶ Qu√©t Pallet</h2>
    <div id="reader"></div>
    
    <div class="stats-bar">
        <span>Ti·∫øn ƒë·ªô: <span id="count">0</span>/4 th√πng</span>
        <button onclick="resetApp()" style="font-size: 12px;">L√†m m·ªõi</button>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th>Th√πng</th>
                <th>M√£ S·∫£n Ph·∫©m</th>
                <th>Gi·ªù</th>
            </tr>
        </thead>
        <tbody id="scanList">
            </tbody>
    </table>

    <button id="confirmBtn" class="btn-confirm" onclick="sendAllData()">X√ÅC NH·∫¨N & L∆ØU GOOGLE SHEET</button>
    <div id="statusMsg" style="margin-top: 10px; font-weight: bold;"></div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw2nIJfqj5v6yAzMZT_wxvabuqM-Lu6fy1Wc3lTRjG-iCBglS7gXudo0xS39f4-a6U1/exec";
    let scannedItems = [];

    function onScanSuccess(decodedText) {
        if (scannedItems.length < 4) {
            // Ki·ªÉm tra tr√πng m√£ (n·∫øu c·∫ßn)
            const now = new Date().toLocaleTimeString('vi-VN');
            scannedItems.push({ maSP: decodedText, ngay: new Date().toLocaleDateString('vi-VN') + ' ' + now, soLuong: 1 });
            
            updateUI();
            
            // √Çm thanh b√°o hi·ªáu (t√πy ch·ªçn)
            const audio = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');
            audio.play();

            if (scannedItems.length === 4) {
                document.getElementById('confirmBtn').style.display = 'block';
                document.getElementById('statusMsg').innerText = "ƒê√£ ƒë·ªß 4 th√πng! Vui l√≤ng ki·ªÉm tra v√† nh·∫•n X√°c nh·∫≠n.";
            }
        }
    }

    function updateUI() {
        const list = document.getElementById('scanList');
        list.innerHTML = "";
        scannedItems.forEach((item, index) => {
            list.innerHTML += `<tr><td>${index + 1}</td><td>${item.maSP}</td><td>${item.ngay.split(' ')[1]}</td></tr>`;
        });
        document.getElementById('count').innerText = scannedItems.length;
    }

    async function sendAllData() {
        const btn = document.getElementById('confirmBtn');
        const msg = document.getElementById('statusMsg');
        
        btn.classList.add('loading');
        btn.innerText = "ƒêANG G·ª¨I...";
        
        try {
            for (let data of scannedItems) {
                await fetch(WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors", // ƒê·ªÉ tr√°nh l·ªói CORS khi d√πng Google Script
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
            }
            msg.style.color = "green";
            msg.innerText = "‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng l√™n Google Sheet!";
            btn.style.display = 'none';
            scannedItems = []; // Reset d·ªØ li·ªáu
        } catch (error) {
            msg.style.color = "red";
            msg.innerText = "‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu!";
        }
    }

    function resetApp() {
        location.reload();
    }

    let scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
    scanner.render(onScanSuccess);
</script>

</body>
</html>

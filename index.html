<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu√©t Pallet Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --error: #dc2626; --bg: #f1f5f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        #reader { border-radius: 12px; overflow: hidden; border: 2px solid #cbd5e1; background: #000; }
        .info-card { background: #eff6ff; border-left: 5px solid var(--primary); padding: 15px; margin: 15px 0; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f8fafc; color: #64748b; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-confirm { background: var(--success); color: white; display: none; }
        .btn-save { background: var(--primary); color: white; margin-top: 20px; }
        .status { font-weight: bold; margin: 10px 0; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; color: #1e293b;">üì¶ Qu·∫£n L√Ω Pallet</h2>
    
    <div id="reader"></div>
    
    <div id="statusMsg" class="status">S·∫µn s√†ng qu√©t th√πng 1...</div>

    <div id="infoCard" class="info-card">
        <h4 style="margin: 0 0 10px 0;">X√ÅC NH·∫¨N S·∫¢N PH·∫®M:</h4>
        <p><b>M√£ SP:</b> <span id="resMa"></span></p>
        <p><b>T√™n SP:</b> <span id="resTen"></span></p>
        <p><b>M√†u s·∫Øc:</b> <span id="resMau"></span></p>
        <button class="btn btn-confirm" id="btnAccept" onclick="acceptItem()">‚úÖ ƒê√öNG - TI·∫æP T·ª§C</button>
        <button class="btn" style="background:#cbd5e1;" onclick="cancelItem()">H·ª¶Y - QU√âT L·∫†I</button>
    </div>

    <div style="margin-top: 20px;">
        <strong>Danh s√°ch Pallet (<span id="count">0</span>/4 th√πng):</strong>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Th√πng</th>
                    <th>M√£ SP</th>
                    <th>T√™n SP</th>
                </tr>
            </thead>
            <tbody id="logBody"></tbody>
        </table>
    </div>

    <button id="btnFinalSave" class="btn btn-save" style="display: none;" onclick="sendToGoogleSheet()">üíæ L∆ØU D·ªÆ LI·ªÜU L√äN SHEET</button>
</div>

<script>
    // C·∫§U H√åNH T·∫†I ƒê√ÇY
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxfc_Yk9TPXL8Pm2JywkZs0m7y3pzHHlN1_EmHvbEhMyb3l7v6Ec9Aip9V0cKLDVWdM/exec";
    let scannedItems = [];
    let currentData = null; 

    // Kh·ªüi t·∫°o Scanner
    const scanner = new Html5QrcodeScanner("reader", { 
        fps: 20, 
        qrbox: {width: 250, height: 150},
        aspectRatio: 1.0
    });
    scanner.render(onScanSuccess);

    async function onScanSuccess(decodedText) {
        if (scannedItems.length >= 4) return;
        
        // Rung v√† ti·∫øng k√™u khi nh·∫≠n m√£
        if (navigator.vibrate) navigator.vibrate(100);
        new Audio('https://www.soundjay.com/buttons/beep-07.mp3').play();

        scanner.pause(); // D·ª´ng camera ƒë·ªÉ x√°c nh·∫≠n
        document.getElementById('statusMsg').innerText = "üîé ƒêang ki·ªÉm tra danh m·ª•c...";

        try {
            const response = await fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "lookup", maSP: decodedText })
            });
            const result = await response.json();

            if (result.found) {
                currentData = {
                    maSP: decodedText,
                    tenSP: result.tenSP,
                    mauSac: result.mauSac,
                    ngay: new Date().toLocaleString('vi-VN'),
                    soLuong: 1
                };
                showInfo(currentData);
            } else {
                alert("‚ùå Kh√¥ng t√¨m th·∫•y m√£ n√†y trong tab Products!");
                scanner.resume();
                document.getElementById('statusMsg').innerText = "Vui l√≤ng qu√©t l·∫°i...";
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi: " + e);
            scanner.resume();
        }
    }

    function showInfo(data) {
        document.getElementById('infoCard').style.display = 'block';
        document.getElementById('btnAccept').style.display = 'block';
        document.getElementById('resMa').innerText = data.maSP;
        document.getElementById('resTen').innerText = data.tenSP;
        document.getElementById('resMau').innerText = data.mauSac;
        document.getElementById('statusMsg').innerText = "Ch·ªù x√°c nh·∫≠n...";
    }

    function acceptItem() {
        scannedItems.push(currentData);
        updateTable();
        
        document.getElementById('infoCard').style.display = 'none';
        
        if (scannedItems.length < 4) {
            document.getElementById('statusMsg').innerText = `ƒê√£ xong th√πng ${scannedItems.length}. Qu√©t ti·∫øp...`;
            scanner.resume();
        } else {
            document.getElementById('statusMsg').innerText = "üî• ƒê√£ ƒë·ªß 4 th√πng! Nh·∫•n L∆∞u ngay.";
            document.getElementById('btnFinalSave').style.display = 'block';
            scanner.clear(); // T·∫Øt camera ho√†n to√†n
        }
    }

    function cancelItem() {
        document.getElementById('infoCard').style.display = 'none';
        document.getElementById('statusMsg').innerText = "ƒê√£ h·ªßy. Vui l√≤ng qu√©t l·∫°i.";
        scanner.resume();
    }

    function updateTable() {
        const body = document.getElementById('logBody');
        body.innerHTML = scannedItems.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item.maSP}</td>
                <td>${item.tenSP}</td>
            </tr>
        `).join('');
        document.getElementById('count').innerText = scannedItems.length;
    }

    async function sendToGoogleSheet() {
    const btn = document.getElementById('btnFinalSave');
    btn.disabled = true;
    btn.innerText = "‚è≥ ƒêANG L∆ØU...";

    try {
        for (let item of scannedItems) {
            // G·ª≠i d·ªØ li·ªáu theo ƒë√∫ng c·∫•u tr√∫c 2 th√¥ng tin c·∫ßn thi·∫øt
            await fetch(WEB_APP_URL, {
                method: "POST",
                mode: "no-cors", // Tr√°nh l·ªói CORS tr√™n m·ªôt s·ªë tr√¨nh duy·ªát di ƒë·ªông
                body: JSON.stringify({ 
                    action: "save", 
                    maSP: item.maSP,  // S·∫Ω v√†o c·ªôt A
                    ngay: item.ngay   // S·∫Ω v√†o c·ªôt B
                })
            });
        }
        alert("‚úÖ ƒê√É L∆ØU 4 TH√ôNG V√ÄO C·ªòT A & B!");
        location.reload(); 
    } catch (e) {
        alert("L·ªói k·∫øt n·ªëi: " + e);
        btn.disabled = false;
    }
}
</script>

</body>
</html>
